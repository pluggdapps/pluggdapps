#! /usr/bin/env python3.2

# -*- coding: utf-8 -*-

# This file is subject to the terms and conditions defined in
# file 'LICENSE', which is part of this source code package.
#       Copyright (c) 2011 Netscale Computing

import sys, os, signal, subprocess
from   argparse     import ArgumentParser
from   os.path      import dirname, join

import pluggdapps
from   pluggdapps.const      import DEFAULT_INI
from   pluggdapps.platform   import Pluggdapps
from   pluggdapps.plugin     import query_plugins, PluginMeta, pluginname
from   pluggdapps.interfaces import ICommand
import pluggdapps.utils as h


def mainoptions() :
    # setup main script arguments
    description = "Pluggdapps command line script."
    mainparser = ArgumentParser( description=description )
    mainparser.add_argument( '-c',
                             dest='config', default=DEFAULT_INI,
                             help="specify config file(s)" )
    return mainparser

def main():
    # Create command line parser.
    # Get a list of sub-commands supported in command line.
    # Take only the command-line parameters uptil a subcommand.
    mainparser = mainoptions()
    subcmds = [ x[7:] for x in PluginMeta._implementers[ ICommand ].keys() ]
    mainargs = takewhile( lambda x : x not in subcmds, sys.argv[1:] )
    args = mainparser.parse_args( mainargs )

    # pluggdapps platform object.
    pa = Pluggdapps.boot( args.config )

    # setup sub-command arguments
    subcommands = query_plugins( pa, None, ICommand, 'commands' )
    subparsers = mainparser.add_subparsers( help="Sub-commands" )
    [ subcmd.subparser( mainparser, subparsers ) for subcmd in subcommands ]

    # Do a full parsing of command line arguments.
    args = mainparser.parse_args()

    pa.bootapps()   # Boot applications

    # Handle subcommand
    args.handler( args )


if __name__ == '__main__' :
    main()
